<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>BHBot Control Panel</title>

    <!-- Bootstrap -->
    <link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
	
	<style>
	.pre-scrollable2 {
    max-height: 600px;
    overflow-y: scroll;
	}
	
	/* https://stackoverflow.com/questions/10085723/twitter-bootstrap-add-top-space-between-rows */
	.top-buffer { margin-top:15px; }
	.bottom-buffer { margin-bottom:15px; }
	
	/**********************************
	Responsive navbar-brand image CSS
	- Remove navbar-brand padding for firefox bug workaround
	- add 100% height and width auto ... similar to how bootstrap img-responsive class works
	***********************************/
	.navbar-brand {
	  padding: 0px 30px 0px 0px;
	  display: flex;
	  align-items: center;
	}
	/*
	.navbar-brand>img {
	  height: 100%;
	  padding: 7px 14px;
	  width: auto;
	}
	*/
	</style>
	
	<link rel="icon" type="image/png" href="logo-small.png" />
  </head>
  <body>
	<div class="container-fluid">
	
	<!-- navbar: https://codepen.io/bootstrapped/pen/KwYGwq -->
	
	<!-- Static navbar -->
	<nav class="navbar navbar-default">
		<div class="container-fluid">
		  <div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
			  <span class="sr-only">Toggle navigation</span>
			  <span class="icon-bar"></span>
			  <span class="icon-bar"></span>
			  <span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="#"><img style="width: 32px; height: 32px; margin: 0px 10px" src="logo-large.png">BHBot
			</a>
		  </div>
		  <div id="navbar" class="navbar-collapse collapse">
			<ul class="nav navbar-nav">
			  <li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Advanced <span class="caret"></span></a>
				<ul class="dropdown-menu">
				  <li><a href="#" onclick="editSettingsDialog();">Edit settings.ini</a></li>
				  <li><a href="#" onclick="reloadSettings();">Reload settings</a></li>
				  <li><a href="#" onclick="window.open('debuglist');">Debug file list...</a></li>
				  <li role="separator" class="divider"></li>
				  <li class="dropdown-header">Admin features</li>
				  <li><a href="#" onclick="stopBotDialog();">Stop bot</a></li>
				  <li><a href="#" onclick="restartDriverDialog();">Restart driver</a></li>
				</ul>
			  </li>
			</ul>
			<ul class="nav navbar-nav navbar-right">
			  <li><a href="#" onclick="showAboutDialog()">About</a></li>
			</ul>
		  </div><!--/.nav-collapse -->
		</div><!--/.container-fluid -->
	</nav>

    <div class="panel panel-default">
		<div class="panel-heading">
			<h3 class="panel-title">BHBot Control Panel</h3>
		</div>
		
		<div class="panel-body">
	
			<!-- enter command form: -->
			<!-- Interesting: https://www.tjvantoll.com/2013/01/01/enter-should-submit-forms-stop-messing-with-that/ -->
			<p>
				<form action="" class="form-inline">
				  <div class="form-group">
					<div class="input-group">
						<div class="input-group-addon">Command:</div>
						<input type="text" class="form-control" id="commandInputAmount" placeholder="Enter your command">
						<div class="input-group-addon"></div>
					</div>
					<button type="submit" class="btn btn-primary" onclick="sendCommand(); return false;">Send</button>
				  </div>
				</form>
			</p>
			
			<!-- number of lines form: -->
			<p>
				<form class="form-inline">
				  <div class="form-group">
					<div class="input-group">
						<div class="input-group-addon">Lines:</div>
						<input type="text" class="form-control" id="linesInputAmount" placeholder="#lines" value="50">
						<div class="input-group-addon"></div>
					</div>
					<button type="submit" class="btn btn-primary" onclick="updateLog(); return false;">Refresh</button>
				  </div>
				</form>
			</p>
			
			
			<div class="row">
				<!-- log: -->
				<div class="col-xs-9">
				<div class="panel panel-info" id="botlog">
					<div class="panel-heading">BHBot output log</div>
					<div class="panel-body">
						<pre class="pre-scrollable2"><code id="log">Log has not been refreshed yet!</code></pre>
					</div>
				</div>
				</div>

				<div class="col-xs-3">
				<div class="panel panel-default">
					<div class="panel-heading">Info</div>
						<div class="panel-body">

							<!-- loading div: -->
							<div class="row">
								<div class="col-lg-2" id="loadingAnimation"><img src="loading.gif" alt="Loading..." /></div>
								<div class="col-lg-8" id="lastUpdatedInfo">Last updated: </div>
							</div>
						
							<!-- message color counters -->
							<table class="table">
							<thead>
								<tr>
									<th>#</th>
									<th>Category</th>
								</tr>
							</thead>
							<tbody>
								<tr class="success">
									<td id="td_counter_success">0</td>
									<td>Success</td>
								</tr>
								<tr class="warning">
									<td id="td_counter_warning">0</td>
									<td>Warning</td>
								</tr>
								<tr class="danger">
									<td id="td_counter_danger">0</td>
									<td>Problem/error</td>
								</tr>
								<tr class="info">
									<td id="td_counter_info">0</td>
									<td>Info</td>
								</tr>
							</tbody>
							
							<!-- Take screenshot
							Links:
							https://stackoverflow.com/questions/22540550/bootstrap-image-popup
							https://stackoverflow.com/questions/25023199/bootstrap-open-image-in-modal
							-->
							<div id="myModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
							  <div class="modal-dialog">
								<div class="modal-content">
									<div class="modal-body">
										<img id="bhbotscreen" src="loading.gif" class="img-responsive" style="margin: 0 auto;">
									</div>
								</div>
							  </div>
							</div>

							<div class="row top-buffer bottom-buffer">
								<div class="col-lg-4">
									<button type="button" class="btn btn-primary" onclick="showScreenshot();">Capture screen</button>
								</div>
								
								<div class="col-lg-4">
									<!-- A filter select: -->
									<select id="multiselect-filter" multiple="multiple">
										<option value="hideReadouts">Hide readouts</option>
										<option value="hideRestarts">Hide soft restarts</option>
										<option value="hideAdTimeouts">Hide ad timeouts</option>
										<option value="showBattleResults">Show only battle results</option>
									</select>
								</div>
							</div>
							
							<div class="row top-buffer bottom-buffer">
								<div class="col-lg-4">
									<button type="button" class="btn btn-warning" onclick="sendSilentCommand('pause');">Pause</button>
								</div>
								
								<div class="col-lg-4">
									<button type="button" class="btn btn-success" onclick="sendSilentCommand('resume');">Resume</button>
								</div>
							</div>
							
						</div>
					</div>
				</div>

			</div><!-- row -->
				
		</div><!-- panel-body -->
	</div><!-- main panel-default -->
	
	</div> <!-- /container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/bootstrap/js/bootstrap.min.js"></script>
	<!-- Include the plugin's CSS and JS: -->
	<script type="text/javascript" src="/bootstrap/js/bootstrap-multiselect.js"></script>
	<link rel="stylesheet" href="/bootstrap/css/bootstrap-multiselect.css" type="text/css"/>
	<!-- Include BootstrapDialog (https://github.com/nakupanda/bootstrap3-dialog): -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.9/css/bootstrap-dialog.min.css" rel="stylesheet" type="text/css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.9/js/bootstrap-dialog.min.js"></script>
	<script>

	function updateLog() {
		document.getElementById('loadingAnimation').childNodes[0].src = "loading.gif";
		$.ajax({url: "getlog", data: {n : getSelectedLogSize()}, success: function(result){
			// how to escape data: http://shebang.brandonmintern.com/foolproof-html-escaping-in-javascript/
			// how to escale data 2: https://stackoverflow.com/questions/24816/escaping-html-strings-with-jquery
			logDiff = getLogDiff(result);
			processLogDiff();
			updateScreenshotIfTaken();
			log = result;
			refreshLog(); // visually update the log
			lastUpdateTime = new Date(); // reset last update time
			updateTimeSinceLastUpdate(); // to refresh it visually
			document.getElementById('loadingAnimation').childNodes[0].src = "ok.png";
		}});
	}

	// visually updates/refreshes the log
	function refreshLog() {
		var text;
		text = applyLogFilters(log);
		text = colorLogLines(escapeHtml(text));
		$("#log").html(text);
		//document.getElementById("log").innerHTML = result;
		goToBottom("log");
		// update message counters:
		$("#td_counter_success").html(numMessagesMap['green']);
		$("#td_counter_warning").html(numMessagesMap['yellow']);
		$("#td_counter_danger").html(numMessagesMap['red']);
		$("#td_counter_info").html(numMessagesMap['blue']);
	}
	
	function processLogDiff() {
		// figure out if bot has been paused/unpaused:
		var state = NO_INFO;
		var pos = -1;
		
		var paused = logDiff.findLastSubstring("Paused.");
		var resumed = logDiff.findLastSubstring("Resumed.");
		var paused_for = logDiff.findLastSubstring("Paused for");
		var stopped = logDiff.findLastSubstring(" has finished.");
		var started = logDiff.findLastSubstring(" started.");
		
		if (paused > pos) {
			state = PAUSED;
			pos = paused;
		}
		if (resumed > pos) {
			state = RESUMED;
			pos = resumed;
		}
		if (paused_for > pos) {
			state = PAUSED_FOR;
			pos = paused_for;
		}
		if (stopped > pos && stopped == logDiff.length-1) {
			state = STOPPED;
			pos = stopped;
		}
		if (started > pos) {
			state = STARTED;
			pos = started;
		}
		
		applyBotState(state);
		
		// find out if settings.ini were reloaded recently:
		if (logDiff.findFirstSubstring("Settings reloaded from disk.") != -1) {
			if (reloadSettingsDialog != null && reloadSettingsDialog.isOpened()) {
				reloadSettingsDialog.setMessage('<img src="ok.png" alt="Done." />' + '<span style="margin-left: 10px">Settings.ini file has been reloaded.</span>');
				// close it in 500 ms from now:
				setTimeout(function() {
					if (reloadSettingsDialog != null && reloadSettingsDialog.isOpened())
						reloadSettingsDialog.close(); 
				}, 500);
			}
		}
		
		// find out if bot has registered a 'restart' command that we sent over:
		if (logDiff.findFirstSubstring("User command: <restart>") != -1) {
			if (restartDriverDialog != null && restartDriverDialog.isOpened()) {
				restartDriverDialog.setMessage('<img src="ok.png" alt="Done." />' + '<span style="margin-left: 10px">Restart command successfully issued.</span>');
				// close it in 500 ms from now:
				setTimeout(function() {
					if (restartDriverDialog != null && restartDriverDialog.isOpened())
						restartDriverDialog.close(); 
				}, 500);
			}
		}
	}
	
	function applyBotState(state) {
		if (state == PAUSED_FOR) {
			//$('#botlog').css('background-color', '#fff39b');
			$('body > div > div > div.panel-heading').css('background-color', '#fff39b');
		} else if (state == RESUMED || state == STARTED) {
			//$('#botlog').css('background-color', 'transparent'); // https://stackoverflow.com/questions/17462003/remove-background-color-attribute-from-css-onmouseover-using-jquery/17462026#17462026
			//$('body > div > div > div.panel-heading').css('background-color', 'transparent');
			
			//$('#botlog').css('background-color', '#d4fdbf');
			$('body > div > div > div.panel-heading').css('background-color', '#d4fdbf');
		} else if (state == PAUSED) {
			//$('#botlog').css('background-color', '#f0cd4e');
			$('body > div > div > div.panel-heading').css('background-color', '#f0cd4e');
		} else if (state == STOPPED) {
			$('body > div > div > div.panel-heading').css('background-color', '#f34f4f'); // red
		}
	}
	
	// will visually update the screenshot popup if the screenshot has been taken recently
	function updateScreenshotIfTaken() {
		if (logDiff.findFirstSubstring("Screenshot saved.") != -1) {
			// https://stackoverflow.com/questions/10802312/display-png-image-as-response-to-jquery-ajax-request
			var oReq = new XMLHttpRequest();
			oReq.open("get", 'getscreenshot', true);        
			oReq.responseType = "blob";
			oReq.onload = function ( oEvent )
			{
				var blob = oReq.response;
				screenshotSrc = URL.createObjectURL( blob );
				$('#bhbotscreen').attr('src', screenshotSrc); // assign received screenshot image to the modal popup
			};
			oReq.send( null );
		}
	}
		
	// returns difference from old log (when we last fetched it from the server) and the new log (which we just fetched from the server).
	function getLogDiff(newLog) {
		var lines = newLog.split("\n");
		var diff = []; // clear it
		
		/*
		if (lastLogLine == "") { // this must be the first update
			lastLogLine = lines[lines.length-1];
			return newLog;
		}
		*/
	
		for (i = lines.length-1; i >= 0; i--) {
			if (lines[i].valueOf() == "") // skip last line, which is an empty line ("")
				continue;
			if (lines[i].valueOf() == lastLogLine.valueOf())
				break;
			diff.push(lines[i]); // we'll reverse the array at the end
		}
		diff.reverse();
		
		lastLogLine = lines[lines.length-1];
		if (lastLogLine.valueOf() == "") // should always be true, since last line is an empty line
			lastLogLine = lines.length > 1 ? lines[lines.length-2] : "";
		
		return diff;
	}
	
	// returns the size of the log that the user has selected. If user has selected some invalid size, it will be set to some default size.
	function getSelectedLogSize() {
		var value = document.getElementById("linesInputAmount").value;
		if (!isInt(value))
			return 50;
			
		return value;
	}
	
	function setSelectedLogSize(value) {
		document.getElementById("linesInputAmount").value = value;
	}
	
	function sendCommand() {
		document.getElementById('commandInputAmount').style.backgroundColor = "#FBFFB0"; // alternative color: #f0ad4e;
		$.ajax({url: "command", data: {cmd : encodeURIComponent(document.getElementById("commandInputAmount").value)}, success: function(result){
			document.getElementById('commandInputAmount').value = "";
			document.getElementById('commandInputAmount').style.backgroundColor = "";
			//window.alert("Command result: " + result);
		}});
	}
	
	function sendSilentCommand(command) {
		$.ajax({url: "command", data: {cmd : encodeURIComponent(command)}});
	}
	
	// https://www.w3schools.com/js/tryit.asp?filename=tryjs_ajax_first
	function loadDoc() {
	  var xhttp = new XMLHttpRequest();
	  xhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
		  document.getElementById("log").innerHTML = this.responseText;
		  goToBottom("log");
		}
	  };
	  xhttp.open("GET", "output.txt", true);
	  xhttp.send();
	}
	
	// https://stackoverflow.com/questions/11715646/scroll-automatically-to-the-bottom-of-the-page
	function goToBottom(id){
	/*
		var element = document.getElementById(id);
		element.scrollTop = element.scrollHeight - element.clientHeight;
		*/
		//document.getElementById("log").scrollTo(0, document.body.scrollHeight || document.documentElement.scrollHeight);
		//document.getElementById("log").scrollTo(0,document.body.scrollHeight);
		 $('#'+id)[0].scrollIntoView(false);
	}
	
	// input must be a String!
	function colorLogLines(text) {
		numMessagesMap['red'] = 0;
		numMessagesMap['yellow'] = 0;
		numMessagesMap['blue'] = 0;
		numMessagesMap['green'] = 0;
	
		var lines = text.split("\n");
	
		for (i = 0; i < lines.length; i++) { 
		/*
			Colors:
			red #f2dede
			yellow #fcf8e3
			blue #d9edf7
			green #dff0d8
		*/
		
			if (lines[i].valueOf() == "") // skip last line, which is an empty line ("")
				continue;
		
			if (lines[i].toLowerCase().indexOf("emergency restart") != -1) {
				lines[i] = "<span style='width: 100%; display:inline-block; background-color: #f2dede;'>"+lines[i]+"</span>";
				numMessagesMap['red']++;
			} else if (lines[i].toLowerCase().indexOf("exception") != -1) {
				lines[i] = "<span style='width: 100%; display:inline-block; background-color: #f2dede;'>"+lines[i]+"</span>";
				numMessagesMap['red']++;
			} else if (lines[i].toLowerCase().indexOf("problem") != -1) {
				lines[i] = "<span style='width: 100%; display:inline-block; background-color: #fcf8e3;'>"+lines[i]+"</span>";
				numMessagesMap['yellow']++;
			} else if (lines[i].toLowerCase().indexOf("user command: ") != -1) {
				lines[i] = "<span style='width: 100%; display:inline-block; background-color: #d9edf7;'>"+lines[i]+"</span>";
				numMessagesMap['blue']++;
			} else if (lines[i].toLowerCase().indexOf("result: victory") != -1) {
				lines[i] = "<span style='width: 100%; display:inline-block; background-color: #dff0d8;'>"+lines[i]+"</span>";
				numMessagesMap['green']++;
			} else if (lines[i].toLowerCase().indexOf("result: defeat") != -1) {
				lines[i] = "<span style='width: 100%; display:inline-block; background-color: #fcf8e3;'>"+lines[i]+"</span>";
				numMessagesMap['yellow']++;
			} else if (lines[i].toLowerCase().indexOf("ad reward successfully claimed") != -1) {
				lines[i] = "<span style='width: 100%; display:inline-block; background-color: #dff0d8;'>"+lines[i]+"</span>";
				numMessagesMap['green']++;
			}
			
		}
	
		return lines.join("\n")+'';
	}
	
	function applyLogFilters(text) {
		var lines = text.split("\n");
		var result = [];
		
		var hideReadouts = $.inArray("hideReadouts", filters) != -1;
		var hideRestarts = $.inArray("hideRestarts", filters) != -1;
		var showBattleResults = $.inArray("showBattleResults", filters) != -1;
		var hideAdTimeouts = $.inArray("hideAdTimeouts", filters) != -1;
		
		for (i = 0; i < lines.length; i++) { 
	
			if (lines[i].valueOf() == "")
				continue;

			if (hideReadouts && lines[i].indexOf("readout:") != -1)
				continue;

			if (hideAdTimeouts && lines[i].indexOf("Last ad has been offered longer ago") != -1)
				continue;

			if (showBattleResults && lines[i].indexOf("completed successfully.") == -1)
				continue;
				
			if (hideRestarts && (
					lines[i].indexOf("Doing driver restart") != -1 || 
					lines[i].indexOf("Driver is up and running") != -1 ||
					lines[i].indexOf("Window handle is:") != -1 ||
					lines[i].indexOf("News popup dismissed") != -1
				)
			)
				continue;
				
			result.push(lines[i]);			
		}
	
		return result.join("\n")+'';
	}
	
	function showScreenshot() {
		// release any previous screenshot image:
		window.URL.revokeObjectURL(screenshotSrc);
		// display loading image:
		$('#bhbotscreen').attr('src', "loading.gif");
		// show the popup:
		$('#myModal').modal('show');
	
		// send command to capture a screenshot to the server:
		$.ajax({cache: false, url: "command", data: {cmd : "shot"}});
	}
	
	function editSettingsDialog() {
		settingsDialog.open();
	}
	
	function showAboutDialog() {
		BootstrapDialog.show({
			title: 'About',
			size: BootstrapDialog.SIZE_WIDE,
			message: '<img src="loading.gif" alt="Loading..." />' + '<span style="margin-left: 10px">Retrieving readme file from the server...</span>',
			onshow: function(dialogRef) {
				// download readme.txt file and display it:
				$.ajax({
					url: 'readme.txt',
					cache: false,
					success: function (data){
						dialogRef.setMessage('<pre class="pre-scrollable2" style="white-space: pre-wrap; word-break: keep-all;">' + escapeHtml(data) + '</pre>');
					},
					error: function () {
						dialogRef.setMessage('<span style="margin-left: 10px">Unable to retrieve readme file from the server.</span>');
					}
				});
			},
			buttons: [{
				label: "Close",
				cssClass: 'btn-primary',
				action: function(dialogRef) {
					dialogRef.close();
				}
			}]
		});
	}
	
	function stopBotDialog() {
		BootstrapDialog.confirm({
            title: 'WARNING',
            message: 'Warning! If you stop the bot, you won\'t be able to restart it again (it has to be started manually from the console). You should probably use the pause command instead. Are you sure you want to stop the bot?',
            type: BootstrapDialog.TYPE_WARNING, // <-- Default value is BootstrapDialog.TYPE_PRIMARY
            closable: true, // <-- Default value is false
            draggable: true, // <-- Default value is false
            btnCancelLabel: 'Cancel', // <-- Default value is 'Cancel',
            btnOKLabel: 'Stop it', // <-- Default value is 'OK',
            btnOKClass: 'btn-warning', // <-- If you didn't specify it, dialog type will be used,
            callback: function(result) {
                // result will be true if button was click, while it will be false if user close the dialog directly.
                if (result) {
                    sendSilentCommand('stop');
                } else {
                    // do nothing
                }
            }
        });
	}
	
	// https://stackoverflow.com/questions/24816/escaping-html-strings-with-jquery
	var entityMap = {
	  '&': '&amp;',
	  '<': '&lt;',
	  '>': '&gt;',
	  '"': '&quot;',
	  "'": '&#39;',
	  '/': '&#x2F;',
	  '`': '&#x60;',
	  '=': '&#x3D;'
	};

	function escapeHtml (string) {
	  return String(string).replace(/[&<>"'`=\/]/g, function (s) {
		return entityMap[s];
	  });
	}
	
	// here we keep track of number of colored messages
	var numMessagesMap = {
		'red' : 0,
		'yellow' : 0,
		'blue' : 0,
		'green': 0
	}
	
	// time when we did last log update:
	var lastUpdateTime = new Date();
	var lastLogSize = 0;
	var lastLogLine = ""; // last line from the log (from when we last fetched log from the server). We use it to construct log changes from the last log state/update.
	var logDiff = []; // log difference between current log contents and last log contents (that is log contents from when we last fetched log from the server)
	var log = ""; // last log received from server (this is an entire log that server sent us)
	var screenshotSrc; // URL pointed to the screenshot blob that we created when we received it from the server.
	var filters = []; // list of selected filters (those that have a tick in front of them)

	// bot state constants:
	var NO_INFO = 1;
	var RESUMED = 2;
	var PAUSED = 3;
	var PAUSED_FOR = 4;	
	var STOPPED = 5;
	var STARTED = 6;
	
	// settings.ini edit dialog:
	var settingsDialog;
	// reload settings dialog (which pops up when we click on the "reload settings" button and we wait for server to reload the settings):
	var reloadSettingsDialog;
	// restart driver dialog:
	var restartDriverDialog;
	
	// this gets called only once, at initialiation phase
	function constructEditSettingsDialog() {
		settingsDialog = new BootstrapDialog();

		// set title:
		settingsDialog.setTitle('Settings.ini');
		
		settingsDialog.options.draggable = true;

		// set "message" (body of the dialog):
		// https://stackoverflow.com/questions/657795/how-remove-word-wrap-from-textarea/13446005#13446005
		var style = " \
			white-space: pre; \
			overflow-wrap: normal; \
			overflow-x: scroll; \
			max-width: 100%; \
			min-height: 400px; \
			font-family: Lucida Console, Courier, monospace; \
		";
		var $message = $('<textarea id="settings_ini" class="form-control" spellcheck="false" style="' + style + '"placeholder="Write your settings.ini file here..."></textarea>');
		settingsDialog.setMessage($message);

		// set buttons:
		settingsDialog.addButton({
			label: "Reload settings",
			cssClass: 'btn-primary',
			action: function() {
				reloadSettings();
			}
		});
		settingsDialog.addButton({
			label: "Retrieve settings",
			id: 'downloadsettingsbutton',
			cssClass: 'btn-primary',
			action: function() {
				clickDownloadSettingsButton();
			}
		});
		settingsDialog.addButton({
			label: 'Upload settings',
			id: 'uploadsettingsbutton',
			cssClass: 'btn-primary',
			action: function() {
				var that = this;
				this.spin();
				// send file to server:
				// https://stackoverflow.com/questions/3012566/how-to-upload-string-as-file-with-jquery-or-other-js-framework
				var blob = new Blob([$('#settings_ini').val()], { type: 'plain/text' });
				var formData = new FormData();
				formData.append('file', blob);
				$.ajax({
					url: "setsettingsfile",
					data: formData,
					processData: false,
					contentType: false,
					type: 'POST',
					success: function(rep) {
						that.stopSpin();
						console.log("Settings.ini file uploaded successfully.");
					},
					error: function () {
						that.stopSpin();
						BootstrapDialog.alert({
							title: 'ERROR',
							message: 'Error: unable to upload file to server!',
							type: BootstrapDialog.TYPE_DANGER
						});
					}
				});
			}
		});
		
		settingsDialog.realize(); // this pretty much creates the dialog (we can't add any more stuff after calling this function). Note that this function gets called automatically on show() the first time we run it. But we prefer to do it here manually, so that we can modify the footer.
		
		// add status label: (https://stackoverflow.com/questions/35377806/how-to-add-labels-to-bootstrap-dialog-footer)
		//settingsDialog.getModalFooter().find('.bootstrap-dialog-footer-buttons').prepend('<span style="text-align: left">Status: ready.</span>');

		// OK we're done!
		//clickDownloadSettingsButton();
		settingsDialog.getButton('downloadsettingsbutton').trigger('click'); // click the button!
	}
	
	// gets called when we click on "download settings.ini" button
	function clickDownloadSettingsButton() {
		var button = settingsDialog.getButton('downloadsettingsbutton');
		button.spin();
		
		$.ajax({
			url: 'getsettingsfile',
			cache: false, // very important! Or else it will just retrieve the old settings.ini file (which is cached) and not the new, modified one!
			success: function (data){
				button.stopSpin();
				//$('#settings_ini').val(data);
				settingsDialog.getModalContent().find("#settings_ini").val(data);
				console.log("Settings.ini file retrieved successfully.");
			},
			error: function () {
				button.stopSpin();
				BootstrapDialog.alert({
					title: 'ERROR',
					message: 'Error: unable to retrieve file from server!',
					type: BootstrapDialog.TYPE_DANGER
				});
			}
		});
	}
	
	function reloadSettings() {
		reloadSettingsDialog = BootstrapDialog.show({
			title: 'Loading',
			message: '<img src="loading.gif" alt="Loading..." />' + '<span style="margin-left: 10px">Waiting for server to load settings.ini file...</span>',
			onshow: function(dialogRef) {
				sendSilentCommand('reload');
			}
		});
	}
	
	function restartDriverDialog() {
		restartDriverDialog = BootstrapDialog.show({
			title: 'Loading',
			message: '<img src="loading.gif" alt="Loading..." />' + '<span style="margin-left: 10px">Waiting for server to acknowledge \'restart\' command...</span>',
			onshow: function(dialogRef) {
				sendSilentCommand('restart');
			}
		});
	}
	
	constructEditSettingsDialog(); // run it just once
	
	applyBotState(RESUMED);
	
	function updateTimeSinceLastUpdate() {
		var d = Math.floor((new Date().getTime() - lastUpdateTime.getTime()) / 1000);
		document.getElementById("lastUpdatedInfo").innerHTML = "Last update: " + d + " seconds ago.";
	}
	
	function periodicalUpdateTimeSinceLastUpdate() {
		updateTimeSinceLastUpdate();
		/*
		if (new Date().getTime() - lastUpdateTime.getTime() > 3000)
			updateLog();
		*/
		setTimeout(periodicalUpdateTimeSinceLastUpdate, 1000);
	}
	periodicalUpdateTimeSinceLastUpdate();
	
	updateLog();
	
	function periodicalLogUpdate() {
		$.ajax({url: "getlogsize", success: function(result){
			var size = Number(result);
			if (size != lastLogSize) {
				lastLogSize = size;
				updateLog();
			}
		}, complete: function() {
			setTimeout(periodicalLogUpdate, 500);
		}});
		
		//***setTimeout(periodicalLogUpdate, 500);
	}
	periodicalLogUpdate();
	
	// source: https://stackoverflow.com/questions/5424488/how-to-search-for-a-string-inside-an-array-of-strings
	Array.prototype.findFirstSubstring = function(s) {
            for(var i = 0; i < this.length;i++)
            {
                if(this[i].indexOf(s) !== -1)
                    return i;
            }
            return -1;
        };
	Array.prototype.findLastSubstring = function(s) {
            for(var i = this.length-1; i >= 0; i--)
            {
                if(this[i].indexOf(s) !== -1)
                    return i;
            }
            return -1;
        };

	// https://stackoverflow.com/questions/14636536/how-to-check-if-a-variable-is-an-integer-in-javascript/14794066#14794066
	function isInt(value) {
	  return !isNaN(value) && 
			 parseInt(Number(value)) == value && 
			 !isNaN(parseInt(value, 10));
	}

	// will read filters values from the <select> and store them to an array
	function applyFilters() {
		// https://stackoverflow.com/questions/20516166/bootstrap-multiselect-get-selected-values
		var brands = $('#multiselect-filter option:selected');
		filters = [];
		$(brands).each(function(index, brand){
			filters.push($(this).val());
		});
		
		refreshLog();
		saveSettings();
		
		//console.log(filters); // debug
	}
	
	function saveSettings() {
		var hideReadouts = $.inArray("hideReadouts", filters) != -1;
		var hideRestarts = $.inArray("hideRestarts", filters) != -1;
		var showBattleResults = $.inArray("showBattleResults", filters) != -1;
		var hideAdTimeouts = $.inArray("hideAdTimeouts", filters) != -1;

		localStorage.setItem("settings_hideReadouts", hideReadouts ? "1" : "0");
		localStorage.setItem("settings_hideRestarts", hideRestarts ? "1" : "0");
		localStorage.setItem("settings_showBattleResults", showBattleResults ? "1" : "0");
		localStorage.setItem("settings_hideAdTimeouts", hideAdTimeouts ? "1" : "0");
		
		localStorage.setItem("settings_numLines", getSelectedLogSize());
	}
	
	function loadSettings() {
		var numLines = localStorage.getItem("settings_numLines");
		if (numLines == null)
			numLines = 50;
		setSelectedLogSize(numLines);
	
		// load filter settings:
	
		// https://stackoverflow.com/questions/6966260/jquery-multiselect-set-a-value-as-selected-in-the-multiselect-dropdown
		
		var dataarray = [];

		if (localStorage.getItem("settings_hideReadouts") == "1")
			dataarray.push("hideReadouts");

		if (localStorage.getItem("settings_hideRestarts") == "1")
			dataarray.push("hideRestarts");

		if (localStorage.getItem("settings_showBattleResults") == "1")
			dataarray.push("showBattleResults");
			
		if (localStorage.getItem("settings_hideAdTimeouts") == "1")
			dataarray.push("hideAdTimeouts");

		// update filters:
		$("#multiselect-filter").val(dataarray); //set values in the <select>
		$("#multiselect-filter").multiselect("refresh"); // finally, refresh the <select>
		applyFilters();
	}
	
	$(function() {
		$('#multiselect-filter').multiselect({
			includeSelectAllOption: true,
			
			// http://davidstutz.github.io/bootstrap-multiselect/#configuration-options-buttonText
			buttonText: function(options, select) {
				return "Filter";
			},
			
			onDropdownHidden: function(event) {
				// update the log in order for the changes to take effect:
				//updateLog();
			},
			
			onChange: function(option, checked, select) {
				applyFilters();
			},
			
			onSelectAll: function(option, checked, select) {
				applyFilters();
			},

			onDeselectAll: function(option, checked, select) {
				applyFilters();
			}
			
		});
		
		console.log("Loading settings..."); // debug
		loadSettings();
		console.log("Settings loaded."); // debug
	});
	
	// make sure settings are saved when we change number of lines:
	$('#linesInputAmount').on('input', function() { 
		saveSettings();
	});
		
	</script>
	
  </body>
</html>